# üöÄ GUIDE DE D√âPLOIEMENT

Ce guide vous explique comment d√©ployer l'Escape Game Coop√©ratif en production.

---

## üìã TABLE DES MATI√àRES

- [Pr√©requis](#-pr√©requis)
- [Configuration Photon](#-configuration-photon)
- [Build de Production](#-build-de-production)
- [D√©ploiement sur Netlify](#-d√©ploiement-sur-netlify)
- [D√©ploiement sur Vercel](#-d√©ploiement-sur-vercel)
- [D√©ploiement sur GitHub Pages](#-d√©ploiement-sur-github-pages)
- [D√©ploiement sur serveur personnalis√©](#-d√©ploiement-sur-serveur-personnalis√©)
- [Variables d'environnement](#-variables-denvironnement)
- [Optimisations](#-optimisations)
- [Monitoring](#-monitoring)
- [Troubleshooting](#-troubleshooting)

---

## ‚úÖ PR√âREQUIS

Avant de d√©ployer, assurez-vous d'avoir :

- ‚úÖ Node.js v16+ install√©
- ‚úÖ npm ou yarn install√©
- ‚úÖ Un compte Photon Engine (gratuit)
- ‚úÖ Git install√©
- ‚úÖ Un compte sur la plateforme de d√©ploiement choisie

---

## üîß CONFIGURATION PHOTON

### 1. Cr√©er un compte Photon

1. Allez sur [Photon Engine](https://www.photonengine.com/)
2. Cr√©ez un compte gratuit
3. Connectez-vous au dashboard

### 2. Cr√©er une application

1. Dans le dashboard, cliquez sur **"Create a New App"**
2. Choisissez **"Photon Realtime"**
3. Donnez un nom √† votre application (ex: "EscapeGameCoop")
4. S√©lectionnez la r√©gion la plus proche de vos joueurs
5. Cliquez sur **"Create"**

### 3. R√©cup√©rer l'App ID

1. Dans la liste de vos applications, cliquez sur votre app
2. Copiez l'**App ID** (format : `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`)

### 4. Configurer l'App ID dans le projet

Ouvrez le fichier `client/src/net/photonClient.ts` et remplacez l'App ID :

```typescript
// Avant
const PHOTON_APP_ID = "YOUR_APP_ID_HERE";

// Apr√®s
const PHOTON_APP_ID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx";
```

**‚ö†Ô∏è IMPORTANT :** Ne commitez JAMAIS votre App ID dans un repository public !

### 5. Utiliser les variables d'environnement (recommand√©)

Cr√©ez un fichier `.env` dans le dossier `client/` :

```env
VITE_PHOTON_APP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

Modifiez `photonClient.ts` pour utiliser la variable :

```typescript
const PHOTON_APP_ID = import.meta.env.VITE_PHOTON_APP_ID || "YOUR_APP_ID_HERE";
```

Ajoutez `.env` au `.gitignore` :

```gitignore
# Environment variables
.env
.env.local
.env.production
```

---

## üèóÔ∏è BUILD DE PRODUCTION

### 1. Nettoyer le projet

```bash
cd client
rm -rf dist node_modules
npm install
```

### 2. Lancer le build

```bash
npm run build
```

### 3. V√©rifier le build

```bash
npm run preview
```

Ouvrez `http://localhost:4173` pour tester le build de production.

### 4. V√©rifier la taille du bundle

Le build devrait afficher :

```
dist/index.html                    9.45 kB ‚îÇ gzip:   2.68 kB
dist/assets/index-[hash].js    1,701.57 kB ‚îÇ gzip: 392.84 kB
```

‚ö†Ô∏è **Note :** Le bundle est volumineux √† cause de Phaser et Photon. Voir [Optimisations](#-optimisations) pour r√©duire la taille.

---

## üåê D√âPLOIEMENT SUR NETLIFY

### M√©thode 1 : D√©ploiement via Git (recommand√©)

#### 1. Pr√©parer le repository

```bash
# Cr√©er un repository Git si ce n'est pas d√©j√† fait
git init
git add .
git commit -m "Initial commit"

# Pousser sur GitHub
git remote add origin https://github.com/votre-username/escape-game.git
git push -u origin main
```

#### 2. Connecter √† Netlify

1. Allez sur [Netlify](https://www.netlify.com/)
2. Cliquez sur **"Add new site"** ‚Üí **"Import an existing project"**
3. Choisissez **GitHub** et autorisez l'acc√®s
4. S√©lectionnez votre repository

#### 3. Configurer le build

```yaml
# Build settings
Base directory: client
Build command: npm run build
Publish directory: client/dist
```

#### 4. Ajouter les variables d'environnement

Dans **Site settings** ‚Üí **Environment variables** :

```
VITE_PHOTON_APP_ID = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

#### 5. D√©ployer

Cliquez sur **"Deploy site"**. Netlify va :
- Installer les d√©pendances
- Lancer le build
- D√©ployer sur un domaine `*.netlify.app`

### M√©thode 2 : D√©ploiement manuel

```bash
# Installer Netlify CLI
npm install -g netlify-cli

# Se connecter
netlify login

# D√©ployer
cd client
npm run build
netlify deploy --prod --dir=dist
```

### Configuration netlify.toml

Cr√©ez un fichier `netlify.toml` √† la racine du projet :

```toml
[build]
  base = "client"
  command = "npm run build"
  publish = "dist"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[build.environment]
  NODE_VERSION = "18"
```

---

## ‚ñ≤ D√âPLOIEMENT SUR VERCEL

### M√©thode 1 : D√©ploiement via Git

#### 1. Connecter √† Vercel

1. Allez sur [Vercel](https://vercel.com/)
2. Cliquez sur **"Add New"** ‚Üí **"Project"**
3. Importez votre repository GitHub

#### 2. Configurer le projet

```yaml
Framework Preset: Vite
Root Directory: client
Build Command: npm run build
Output Directory: dist
Install Command: npm install
```

#### 3. Ajouter les variables d'environnement

Dans **Settings** ‚Üí **Environment Variables** :

```
VITE_PHOTON_APP_ID = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

#### 4. D√©ployer

Cliquez sur **"Deploy"**. Vercel va d√©ployer automatiquement.

### M√©thode 2 : D√©ploiement via CLI

```bash
# Installer Vercel CLI
npm install -g vercel

# Se connecter
vercel login

# D√©ployer
cd client
vercel --prod
```

### Configuration vercel.json

Cr√©ez un fichier `vercel.json` dans le dossier `client/` :

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

---

## üìÑ D√âPLOIEMENT SUR GITHUB PAGES

### 1. Configurer vite.config.ts

Modifiez `client/vite.config.ts` :

```typescript
import { defineConfig } from 'vite';

export default defineConfig({
  base: '/escape-game/', // Remplacez par le nom de votre repo
  build: {
    outDir: 'dist',
  },
});
```

### 2. Cr√©er un script de d√©ploiement

Cr√©ez `client/deploy.sh` :

```bash
#!/usr/bin/env sh

# Arr√™ter en cas d'erreur
set -e

# Build
npm run build

# Naviguer dans le dossier de build
cd dist

# Cr√©er un repository Git
git init
git add -A
git commit -m 'Deploy'

# Pousser sur la branche gh-pages
git push -f git@github.com:votre-username/escape-game.git main:gh-pages

cd -
```

### 3. Rendre le script ex√©cutable

```bash
chmod +x deploy.sh
```

### 4. D√©ployer

```bash
./deploy.sh
```

### 5. Activer GitHub Pages

1. Allez dans **Settings** ‚Üí **Pages**
2. Source : **Deploy from a branch**
3. Branch : **gh-pages** / **root**
4. Cliquez sur **Save**

Votre site sera disponible sur `https://votre-username.github.io/escape-game/`

---

## üñ•Ô∏è D√âPLOIEMENT SUR SERVEUR PERSONNALIS√â

### Option 1 : Serveur statique (Nginx)

#### 1. Build le projet

```bash
cd client
npm run build
```

#### 2. Copier les fichiers sur le serveur

```bash
scp -r dist/* user@votre-serveur.com:/var/www/escape-game/
```

#### 3. Configurer Nginx

Cr√©ez `/etc/nginx/sites-available/escape-game` :

```nginx
server {
    listen 80;
    server_name escape-game.votre-domaine.com;
    root /var/www/escape-game;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache des assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Compression gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

#### 4. Activer le site

```bash
sudo ln -s /etc/nginx/sites-available/escape-game /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 5. Configurer HTTPS avec Let's Encrypt

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d escape-game.votre-domaine.com
```

### Option 2 : Serveur Node.js (Express)

#### 1. Cr√©er un serveur Express

Cr√©ez `server.js` √† la racine :

```javascript
const express = require('express');
const path = require('path');
const app = express();
const PORT = process.env.PORT || 3000;

// Servir les fichiers statiques
app.use(express.static(path.join(__dirname, 'client/dist')));

// Toutes les routes renvoient index.html
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'client/dist/index.html'));
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

#### 2. Installer les d√©pendances

```bash
npm install express
```

#### 3. Cr√©er un script de d√©marrage

Dans `package.json` :

```json
{
  "scripts": {
    "start": "node server.js",
    "build": "cd client && npm run build"
  }
}
```

#### 4. D√©ployer avec PM2

```bash
# Installer PM2
npm install -g pm2

# D√©marrer l'application
pm2 start server.js --name escape-game

# Sauvegarder la configuration
pm2 save

# D√©marrage automatique au boot
pm2 startup
```

---

## üîê VARIABLES D'ENVIRONNEMENT

### Variables disponibles

| Variable | Description | Exemple |
|----------|-------------|---------|
| `VITE_PHOTON_APP_ID` | App ID Photon | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| `VITE_PHOTON_REGION` | R√©gion Photon | `eu`, `us`, `asia` |
| `VITE_API_URL` | URL de l'API (si backend) | `https://api.example.com` |

### Configuration par environnement

#### D√©veloppement (`.env.development`)

```env
VITE_PHOTON_APP_ID=dev-app-id
VITE_PHOTON_REGION=eu
```

#### Production (`.env.production`)

```env
VITE_PHOTON_APP_ID=prod-app-id
VITE_PHOTON_REGION=eu
```

### Utilisation dans le code

```typescript
const config = {
  photonAppId: import.meta.env.VITE_PHOTON_APP_ID,
  photonRegion: import.meta.env.VITE_PHOTON_REGION || 'eu',
  apiUrl: import.meta.env.VITE_API_URL || 'http://localhost:3000',
};
```

---

## ‚ö° OPTIMISATIONS

### 1. R√©duire la taille du bundle

#### Code Splitting

Modifiez `vite.config.ts` :

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'phaser': ['phaser'],
          'photon': ['photon'],
          'ink': ['inkjs'],
        },
      },
    },
  },
});
```

#### Lazy Loading des sc√®nes

```typescript
// Au lieu de
import { ServerRoomScene } from './scenes/ServerRoomScene';

// Utilisez
const ServerRoomScene = () => import('./scenes/ServerRoomScene');
```

### 2. Compression

#### Activer la compression Brotli

Dans `vite.config.ts` :

```typescript
import viteCompression from 'vite-plugin-compression';

export default defineConfig({
  plugins: [
    viteCompression({
      algorithm: 'brotliCompress',
      ext: '.br',
    }),
  ],
});
```

### 3. Cache des assets

Configurez les headers de cache :

```nginx
# Nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 4. CDN

Utilisez un CDN pour Phaser et Photon :

```html
<!-- Dans index.html -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
<script src="https://cdn.photonengine.com/photon.min.js"></script>
```

---

## üìä MONITORING

### 1. Google Analytics

Ajoutez dans `index.html` :

```html
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX');
</script>
```

### 2. Sentry (Error Tracking)

```bash
npm install @sentry/browser
```

Dans `main.ts` :

```typescript
import * as Sentry from "@sentry/browser";

Sentry.init({
  dsn: "https://xxxxx@sentry.io/xxxxx",
  environment: import.meta.env.MODE,
});
```

### 3. Photon Dashboard

Surveillez les m√©triques dans le dashboard Photon :
- Nombre de joueurs connect√©s
- Nombre de salles actives
- Latence moyenne
- Erreurs de connexion

---

## üêõ TROUBLESHOOTING

### Probl√®me : Le jeu ne se charge pas

**Solution :**
1. V√©rifiez la console (F12)
2. V√©rifiez que l'App ID Photon est correct
3. V√©rifiez que les fichiers sont bien servis (Network tab)

### Probl√®me : Erreur CORS

**Solution :**
Configurez les headers CORS sur votre serveur :

```nginx
add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
```

### Probl√®me : Les assets ne se chargent pas

**Solution :**
V√©rifiez le `base` dans `vite.config.ts` :

```typescript
export default defineConfig({
  base: '/', // Pour domaine racine
  // OU
  base: '/escape-game/', // Pour sous-dossier
});
```

### Probl√®me : Photon ne se connecte pas

**Solution :**
1. V√©rifiez l'App ID
2. V√©rifiez la r√©gion Photon
3. V√©rifiez les quotas (plan gratuit limit√©)
4. V√©rifiez le firewall (port 443 ouvert)

### Probl√®me : Build trop volumineux

**Solution :**
1. Activez le code splitting
2. Utilisez des CDN pour les librairies
3. Activez la compression Brotli
4. Supprimez les d√©pendances inutilis√©es

---

## üìù CHECKLIST DE D√âPLOIEMENT

Avant de d√©ployer en production :

- [ ] ‚úÖ App ID Photon configur√©
- [ ] ‚úÖ Variables d'environnement d√©finies
- [ ] ‚úÖ Build de production test√© localement
- [ ] ‚úÖ Tous les tests passent
- [ ] ‚úÖ Compression activ√©e
- [ ] ‚úÖ HTTPS configur√©
- [ ] ‚úÖ Cache des assets configur√©
- [ ] ‚úÖ Monitoring configur√© (Analytics, Sentry)
- [ ] ‚úÖ Documentation √† jour
- [ ] ‚úÖ README avec instructions de d√©ploiement
- [ ] ‚úÖ `.env` dans `.gitignore`
- [ ] ‚úÖ Domaine personnalis√© configur√© (optionnel)

---

## üîÑ MISE √Ä JOUR

### D√©ploiement continu (CI/CD)

#### GitHub Actions

Cr√©ez `.github/workflows/deploy.yml` :

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        cd client
        npm ci
    
    - name: Build
      env:
        VITE_PHOTON_APP_ID: ${{ secrets.PHOTON_APP_ID }}
      run: |
        cd client
        npm run build
    
    - name: Deploy to Netlify
      uses: netlify/actions/cli@master
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      with:
        args: deploy --prod --dir=client/dist
```

---

## üìû SUPPORT

Si vous rencontrez des probl√®mes de d√©ploiement :

- **Documentation Netlify** : https://docs.netlify.com/
- **Documentation Vercel** : https://vercel.com/docs
- **Documentation Photon** : https://doc.photonengine.com/
- **GitHub Issues** : [Lien vers votre repo]

---

## üéâ F√âLICITATIONS !

Votre Escape Game Coop√©ratif est maintenant d√©ploy√© en production ! üöÄ

N'oubliez pas de :
- üìä Surveiller les m√©triques
- üêõ Corriger les bugs rapidement
- üí¨ √âcouter les retours des joueurs
- üîÑ Mettre √† jour r√©guli√®rement

---

<div align="center">

**Bon d√©ploiement ! üéÆ**

[üè† Retour au README](README.md) | [üìö Documentation](GAME_IMPLEMENTATION.md) | [üéÆ Guide Joueurs](GUIDE_JOUEURS.md)

</div>